<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Deploy Your Django Project In Ec2 Instance</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@joots84" /><meta name="twitter:title" content="Deploy Your Django Project In Ec2 Instance" /><meta name="twitter:description" content="Deploying one (or multiple) Django project(s) in a EC2 instance at AWS it is a relative easy task."><meta name="description" content="Deploying one (or multiple) Django project(s) in a EC2 instance at AWS it is a relative easy task."><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/deploy-your-django-project-in-ec2-instance"><link rel="alternate" type="application/atom+xml" title="Jose's blog" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="/assets/profile.jpg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Deploy Your Django Project In Ec2 Instance</h1><time>June 14, 2016</time></div><div class="divider"></div><p>Deploying one (or multiple) Django project(s) in a EC2 instance at AWS it is a <em>relative easy task</em>.</p><p>I have never been interested in becoming a Systems Administrator. I was this kind of developers that panic messing up with the server, although I always find the topic interesting.</p><p>So here I am, my actual job competences includes the deployment of some of the projects I am working on. Maybe is it time to consider myself a full-stack developer?</p><h2 id="introduction">Introduction</h2><p>First of all, I am going to introduce some definitions, that I assume you probably know if you are reading this post. You can skip this part, if you want to go straight to the point, and start directly with the deployment.</p><p>Actually, I got some of the information by copy-paste of their official pages, so you can not blame me if it is not well explained or accurate.</p><p>Here some brief definitions about Django, Amazon Web Services and EC2 instances:</p><p><a href="https://www.djangoproject.com/">Django</a> is a Python Web framework, for quick setup and easy development of Web applications.</p><p><a href="https://aws.amazon.com/what-is-aws/">AWS</a>, as the link describes, is the most popular secure cloud services platform that offer a wide of utilities as cloud hosting services, database storage or content delivery, among others.</p><p>In AWS, an <a href="https://aws.amazon.com/ec2/">EC2 instance</a> is a Web service that makes easy to obtain virtual services (computer instances in the cloud) fast and inexpensively.</p><h3 id="before-starting">Before starting</h3><p>Well, your Django project it is in your local machine, so first we need to compress and transfer it to our EC2 virtual server. I usually use scp command for ssh data transfer. Here an example:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>scp -i your_permission_PEM_file your_django_project_compressed user_name@IP_EC2_INSTANE:<span class="s2">"/path/where/to/locate/at/ec2/"</span>
</code></pre></div><p>Once finished the transfer, it is time to access to our EC2 instance server with full administrative control, and start the deployment of the project.</p><p>To be ready, we still need to uncompress our django project, and move the project to our desired work path location.</p><h2 id="prepare-nginx-and-uwsgi">Prepare nginx and uWSGI</h2><p><a href="https://www.nginx.com/resources/wiki/">nginx</a> will work as our HTTP server and reverse proxy for our Django project. If it is not installed yet in our server:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo apt-get install nginx
</code></pre></div><h3 id="our-serverini-file">Our server.ini file</h3><p>We now need to configure our django project to run with our nginx server. We need to create the configuration file server_settings/nginx/server.ini included in our project (we can copy and edit its sample file as a reference).</p><p>If you are using multiple websites on uWSGI, you may use a different name for this configuration file for every project.</p><div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="n">uwsgi</span><span class="p">]</span>

<span class="n">chdir</span>       <span class="o">=</span> 
<span class="n">module</span>      <span class="o">=</span> <span class="n">webui</span><span class="o">.</span><span class="n">wsgi</span>
<span class="n">home</span>        <span class="o">=</span> 

<span class="n">socket</span> <span class="o">=</span> <span class="o">/</span><span class="n">server_settings</span><span class="o">/</span><span class="n">socket</span><span class="o">/</span><span class="n">webui</span><span class="o">.</span><span class="n">sock</span>
<span class="n">chmod</span><span class="o">-</span><span class="n">socket</span> <span class="o">=</span> <span class="mi">666</span>

<span class="n">master</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">vhost</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">no</span><span class="o">-</span><span class="n">stie</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">workers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nb">reload</span><span class="o">-</span><span class="n">mercy</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">vacuum</span> <span class="o">=</span> <span class="n">true</span>
<span class="nb">max</span><span class="o">-</span><span class="n">requests</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">limit</span><span class="o">-</span><span class="k">as</span> <span class="o">=</span> <span class="mi">768</span>
<span class="nb">buffer</span><span class="o">-</span><span class="n">sizi</span> <span class="o">=</span> <span class="mi">30000</span>
<span class="n">pidfile</span> <span class="o">=</span> <span class="o">./</span><span class="n">uwsgi</span><span class="o">.</span><span class="n">pid</span>
<span class="n">daemonize</span> <span class="o">=</span> <span class="o">./</span><span class="n">uwsgi</span><span class="o">.</span><span class="n">log</span>
</code></pre></div><p>‘chdir’, is the location of the /webui folder in our django project.</p><p>‘home’, is the location of the Python version we are going to use for our project.</p><p>‘socket’, is the location of our .sock file. A socket file is used to pass information between applications amongst other applications, we have to create when multiple websites with nginx a different socket file (change the file name for every project).</p><p>We may also want to modify the ‘pidfile’ and ‘daemonize’ value, pointing to the absolute path location of the uWSGI pid path, and the uWSGI log path, respectively.</p><p>We can check if our configuration is correct by running uwsgi. The following command should create and save the log files with all the relevant information:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>uwsgi --ini server.ini
</code></pre></div><h3 id="the-nginx-configuration-file-on-django">The nginx configuration file on Django</h3><p>Now is time to copy and edit the webui_nginx.conf file located at the same path of our Django project (server_settings/nginx/). If you are using multiple websites on nginx, you may use a different name for this configuration file for every project.</p><div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># mysite_nginx.conf</span>

<span class="c"># the upstream component nginx needs to connect to</span>
<span class="n">upstream</span> <span class="n">django</span> <span class="p">{</span>
    <span class="n">server</span> <span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">server_settings</span><span class="o">/</span><span class="n">socket</span><span class="o">/</span><span class="n">webui</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span> <span class="c"># for a file socket</span>
    <span class="c">#server 127.0.0.1:8001; # for a web port socket (we'll use this first)</span>
<span class="p">}</span>

<span class="c"># configuration of the server</span>
<span class="n">server</span> <span class="p">{</span>
    <span class="c"># the port your site will be served on</span>
    <span class="n">listen</span>      <span class="p">;</span>
    <span class="c"># the domain name it will serve for</span>
    <span class="n">server_name</span> <span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span> <span class="c"># substitute your machine's IP address or FQDN</span>
    <span class="n">charset</span>     <span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="p">;</span>

    <span class="c"># max upload size</span>
    <span class="n">client_max_body_size</span> <span class="mi">75</span><span class="n">M</span><span class="p">;</span>   <span class="c"># adjust to test</span>

    <span class="n">gzip_comp_level</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">gzip_vary</span> <span class="n">on</span><span class="p">;</span>
    <span class="n">gzip_min_length</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="n">gzip_proxied</span> <span class="nb">any</span><span class="p">;</span>
    <span class="n">gzip_types</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span> <span class="n">text</span><span class="o">/</span><span class="n">css</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span> <span class="n">applicationx</span><span class="o">-</span><span class="n">javascript</span> <span class="n">text</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="o">+</span><span class="n">rss</span> <span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">;</span>
    <span class="n">gzip_buffers</span> <span class="mi">16</span> <span class="mi">8</span><span class="n">k</span><span class="p">;</span>


    <span class="c"># Django media</span>
    <span class="n">location</span> <span class="o">/</span><span class="n">media</span>  <span class="p">{</span>
        <span class="n">alias</span> <span class="o">/</span><span class="n">webui</span><span class="o">/</span><span class="n">media</span><span class="p">;</span>  <span class="c"># your Django project's media files - amend as required</span>
    <span class="p">}</span>

    <span class="n">location</span> <span class="o">/</span><span class="n">static</span> <span class="p">{</span>
        <span class="n">alias</span> <span class="o">/</span><span class="n">webui</span><span class="o">/</span><span class="n">static</span><span class="p">;</span> <span class="c"># your Django project's static files - amend as required</span>
    <span class="p">}</span>

    <span class="c"># Finally, send all non-media requests to the Django server.</span>
    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">uwsgi_pass</span>  <span class="n">django</span><span class="p">;</span>
        <span class="n">include</span>     <span class="o">/</span><span class="n">server_settings</span><span class="o">/</span><span class="n">wsgi</span><span class="o">/</span><span class="n">uwsgi_params</span><span class="p">;</span> <span class="c"># the uwsgi_params file you installed</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Here just modifiying the server file socket url, I eventually use unix sockets, it’s simplier, and there is less overhead than ports.</p><p>Also there is the need of modifying the port the site will be served from (‘listen’), the location of the static and media files (usually located inside the /webui folder), in addition of the non-media requests to the Django server.</p><p>It is very important, if we are going to run multiple websites with nginx, that the location of the ‘uwsgi_pass’ value should point to the proper upstream (better rename the upstreams, to avoid failures).</p><h2 id="get-ready-with-nginx">Get ready with nginx</h2><p>Now is time to reestart nginx:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo /etc/init.d/nginx restart
</code></pre></div><p>Console should print a message like: <code class="highlighter-rouge"> * Restarting nginx nginx [OK] </code></p><p>If the process fails, you can check if the config files are correct by running:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo nginx -t
</code></pre></div><p>I usually try to see what might be hogging the ports used by nginx by running netstat command. For instance, if nginx has to run two Django projects using the ports 80 and 8080, I run:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>netstat -nlp | grep 80
</code></pre></div><p>It should print both ports listening with nginx. Now, we can check the running status using the following command:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>ps aux | grep uwsgi
</code></pre></div><p>Let’s link the webui_nginx.conf file, with the nginx nginx site-enabled folder. Should be located in /etc/nginx/sites-enabled.</p><p>This directory is used to define configurations for our websites, usually symbolically linked to the sites-enabled directory when they are ready to go life. We are going to use:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>ln -s /path/to/django/project/nginx/file.conf /etc/nginx/sites-enabled/
<span class="nb">exec </span>bash
</code></pre></div><h2 id="get-ready-with-uwsgi">Get ready with uWSGI</h2><p>In this example, we are going to use uWSGI’s Emperor mode, which makes deploying multiple apps very simple.</p><p>uWSGI will simply search in a folder for the .ini files and spawn instances of our apps (Django, in this case). By convention, that directory is /etc/uwsgi/vassals/ and we need to create it if it is not already created.</p><p>Let’s create the symlink then:</p><div class="language-sh highlighter-rouge"><pre class="highlight"><code>ln -s /path/to/django/project/nginx/server.ini /etc/uwsgi/vassals/
</code></pre></div><p>With this step, we finished the deployment of our Django project in our EC2 instance. We now just need to test if it is working by openning the site in our browser.</p><p>Cheers!</p></article><div class="back"> <a href="/">Back</a></div></main></body></html>